name: PyTorch Linear Regression CI/CD

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r models/linear-regression/requirements.txt
        pip install pytest pytest-html
        
    - name: Run basic tests
      run: |
        cd models/linear-regression
        python -c "
        import torch
        import numpy as np
        import matplotlib
        matplotlib.use('Agg')
        import matplotlib.pyplot as plt
        
        print('âœ… PyTorch and dependencies imported successfully')
        print(f'PyTorch version: {torch.__version__}')
        print(f'NumPy version: {np.__version__}')
        
        # Test basic tensor operations
        x = torch.randn(10, 1)
        y = 2 * x + 3
        print('âœ… Basic tensor operations successful')
        
        # Test model import
        from simple_linear_regression import SimpleLinearModel
        model = SimpleLinearModel()
        print('âœ… Model import and creation successful')
        
        print('âœ… All basic tests passed')
        "
        
    - name: Generate simple report
      run: |
        cd models/linear-regression
        python -c "
        import torch
        from datetime import datetime
        
        # Create simple HTML report
        html_content = f'''
        <!DOCTYPE html>
        <html>
        <head>
            <title>PyTorch Build Report</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }}
                .header {{ text-align: center; color: #333; border-bottom: 2px solid #007acc; padding-bottom: 20px; }}
                .success {{ color: #28a745; font-weight: bold; }}
            </style>
        </head>
        <body>
            <div class=\"container\">
                <div class=\"header\">
                    <h1>ðŸš€ PyTorch Build Report</h1>
                    <p>Generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC</p>
                </div>
                <h2 class=\"success\">âœ… Build Successful</h2>
                <p>PyTorch version: {torch.__version__}</p>
                <p>All dependencies installed and tested successfully.</p>
                <p>Linear regression model is ready to use.</p>
            </div>
        </body>
        </html>
        '''
        
        with open('report.html', 'w') as f:
            f.write(html_content)
        
        print('âœ… Simple report generated')
        "
        
    - name: Move artifacts to root
      run: |
        mv models/linear-regression/report.html ./
        
    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: pytorch-report
        path: report.html
          
    - name: Setup Pages
      if: github.ref == 'refs/heads/master'
      uses: actions/configure-pages@v4
      
    - name: Upload Pages artifact
      if: github.ref == 'refs/heads/master'
      uses: actions/upload-pages-artifact@v3
      with:
        path: |
          index.html
          models/
          LICENSE
          README.md
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/master'
      id: deployment
      uses: actions/deploy-pages@v4
